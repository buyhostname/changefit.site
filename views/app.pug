extends layout

block head
  style.
    .photo-box {
      width: 80px; height: 80px;
      border: 1px solid #333; border-radius: 5px;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; background: #111;
    }
    .photo-box img { width: 100%; height: 100%; object-fit: cover; }
    .preset-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .preset-item {
      aspect-ratio: 1; border-radius: 5px; overflow: hidden;
      border: 2px solid transparent; cursor: pointer;
      background: #111; transition: border-color 0.15s;
    }
    .preset-item:hover { border-color: #444; }
    .preset-item.selected { border-color: #fff; }
    .preset-item img { width: 100%; height: 100%; object-fit: cover; }
    .chip { 
      padding: 6px 12px; border-radius: 5px; font-size: 13px;
      border: 1px solid #333; cursor: pointer; transition: all 0.15s;
    }
    .chip.active { background: #fff; color: #000; border-color: #fff; }
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: flex; align-items: flex-end; justify-content: center;
      z-index: 100;
    }
    .modal-content {
      width: 100%; max-width: 400px; background: #000;
      border-top: 1px solid #222; padding: 24px 20px 40px;
      max-height: 80vh; overflow-y: auto;
    }
    .result-card { border: 1px solid #222; border-radius: 5px; overflow: hidden; }
    .result-card img { width: 100%; display: block; }
    .result-header { padding: 12px 16px; border-bottom: 1px solid #222; font-size: 13px; }
    .result-error { padding: 16px; color: #f66; font-size: 13px; }

block content
  .container(style="padding-top: 20px; padding-bottom: 100px;")
    //- Header
    header.flex.items-center.justify-between.mb-3
      h1(style="font-size: 18px; font-weight: 600; margin: 0;") Try-On
      .flex.gap-1
        button.btn.btn-secondary(onclick="openSettings()" style="padding: 0 12px; height: 32px; font-size: 12px;") Settings
        a.btn.btn-secondary(href="/logout" style="padding: 0 12px; height: 32px; font-size: 12px;") Logout
    
    //- Your Photo
    section.card.mb-2
      .flex.items-center.justify-between.mb-2
        span.text-sm Your Photo
        span#savedBadge.text-xs.text-muted.hidden saved locally
      .flex.items-center.gap-2
        #personPreview.photo-box
          span.text-muted.text-xs +
        .flex.gap-1(style="flex: 1;")
          label.btn.btn-secondary(style="flex: 1; cursor: pointer; font-size: 12px;")
            input(type="file" accept="image/*" capture="environment" onchange="handlePerson(this)" style="display: none;")
            | Camera
          label.btn.btn-secondary(style="flex: 1; cursor: pointer; font-size: 12px;")
            input(type="file" accept="image/*" onchange="handlePerson(this)" style="display: none;")
            | Library
          button.btn.btn-secondary(onclick="clearPerson()" style="padding: 0 10px; font-size: 12px;") ×
    
    //- Wardrobe
    section.card.mb-2
      .flex.items-center.justify-between.mb-2
        span.text-sm Outfit
        .flex.gap-1
          label.btn.btn-secondary(style="padding: 0 10px; height: 28px; font-size: 11px; cursor: pointer;")
            input(type="file" accept="image/*" capture="environment" onchange="handleWardrobe(this)" style="display: none;")
            | + Camera
          label.btn.btn-secondary(style="padding: 0 10px; height: 28px; font-size: 11px; cursor: pointer;")
            input(type="file" accept="image/*" onchange="handleWardrobe(this)" style="display: none;")
            | + Library
      
      #wardrobeGrid.preset-grid
        //- Loaded dynamically
      
      #wardrobePreview.hidden(style="margin-top: 12px;")
        .photo-box(style="width: 100%; height: auto; aspect-ratio: 16/9;")
          img#wardrobePreviewImg(src="" alt="")
        if hasServerKeys
          button#saveWardrobeBtn.btn.w-full.mt-1(onclick="saveWardrobe()" style="height: 32px; font-size: 12px;") Save to Presets
    
    //- Prompt
    section.card.mb-2
      .flex.items-center.justify-between.mb-1
        span.text-sm Instructions
        button.text-xs.text-muted(onclick="clearPrompt()" style="background: none; border: none; cursor: pointer;") Clear
      textarea.input(id="prompt" rows="2" placeholder="e.g., casual summer look...")= lastPrompt
    
    //- Provider
    section.card.mb-2
      span.text-sm(style="display: block; margin-bottom: 12px;") Model
      .flex.gap-1(style="flex-wrap: wrap;")
        label.chip
          input(type="checkbox" name="provider" value="gemini" checked onchange="updateChip(this)" style="display: none;")
          span Gemini
        label.chip
          input(type="checkbox" name="provider" value="grok-imagine-image" onchange="updateChip(this)" style="display: none;")
          span Grok
        label.chip
          input(type="checkbox" name="provider" value="grok-imagine-image-pro" onchange="updateChip(this)" style="display: none;")
          span Grok Pro
    
    //- Results
    #results(style="display: flex; flex-direction: column; gap: 12px;")
  
  //- Fixed Generate Button
  div(style="position: fixed; bottom: 0; left: 0; right: 0; padding: 16px 20px; background: linear-gradient(to top, #000 60%, transparent); z-index: 50;")
    .container(style="padding: 0;")
      button#generateBtn.btn.w-full(onclick="generate()" style="height: 48px;")
        span#btnText Generate
        .hidden#btnLoading.flex.items-center.justify-center.gap-1
          .spinner
          span Processing...
  
  //- Settings Modal
  #settingsModal.modal.hidden(onclick="closeSettings()")
    .modal-content(onclick="event.stopPropagation()")
      h2(style="font-size: 18px; font-weight: 600; margin: 0 0 24px 0;") Settings
      
      div.mb-3
        label.label Change Password
        .flex.gap-1
          input.input#newPassword(type="password" placeholder="New password" style="flex: 1;")
          button.btn(onclick="changePassword()" style="padding: 0 16px;") Save
      
      if !hasServerKeys
        .divider
        div
          label.label API Keys
          div.mb-2
            .flex.items-center.justify-between.mb-1
              span.text-xs Gemini
              a.text-xs(href="https://aistudio.google.com/app/apikey" target="_blank") Get key →
            input.input#geminiKey(type="password" placeholder="AIza...")
          div
            .flex.items-center.justify-between.mb-1
              span.text-xs xAI
              a.text-xs(href="https://console.x.ai/team/default/api-keys" target="_blank") Get key →
            input.input#xaiKey(type="password" placeholder="xai-...")
          button.btn.w-full.mt-2(onclick="saveKeys()") Save Keys
      
      .divider
      button.btn.btn-secondary.w-full(onclick="closeSettings()") Close

block scripts
  script.
    let personData = null, wardrobeData = null, selectedPreset = null, canSave = false;
    
    document.querySelectorAll('.chip').forEach(c => updateChip(c.querySelector('input')));
    
    function updateChip(cb) {
      cb.parentElement.classList.toggle('active', cb.checked);
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
      const saved = localStorage.getItem('personImage');
      if (saved) {
        personData = saved;
        document.getElementById('personPreview').innerHTML = `<img src="${saved}">`;
        document.getElementById('savedBadge').classList.remove('hidden');
      }
      
      try {
        const res = await fetch('/api/settings');
        const data = await res.json();
        if (data.lastPrompt) document.getElementById('prompt').value = data.lastPrompt;
        if (!#{hasServerKeys}) {
          if (data.geminiKey) document.getElementById('geminiKey').value = data.geminiKey;
          if (data.xaiKey) document.getElementById('xaiKey').value = data.xaiKey;
        }
      } catch (e) {}
      
      loadPresets();
    });
    
    async function loadPresets() {
      try {
        const res = await fetch('/api/wardrobe/list');
        const data = await res.json();
        canSave = data.canSave;
        const grid = document.getElementById('wardrobeGrid');
        grid.innerHTML = data.presets.length ? '' : '<p class="text-xs text-muted" style="grid-column: span 4; text-align: center; padding: 16px 0;">No presets</p>';
        data.presets.forEach(name => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'preset-item';
          btn.dataset.preset = name;
          btn.onclick = () => selectPreset(name);
          btn.innerHTML = `<img src="/public/wardrobe/${name}.png" onerror="this.parentElement.remove()">`;
          grid.appendChild(btn);
        });
      } catch (e) {}
    }
    
    function handlePerson(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        personData = e.target.result;
        document.getElementById('personPreview').innerHTML = `<img src="${personData}">`;
        localStorage.setItem('personImage', personData);
        document.getElementById('savedBadge').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
    
    function clearPerson() {
      personData = null;
      document.getElementById('personPreview').innerHTML = '<span class="text-muted text-xs">+</span>';
      document.getElementById('savedBadge').classList.add('hidden');
    }
    
    function selectPreset(name) {
      selectedPreset = name;
      wardrobeData = null;
      document.querySelectorAll('.preset-item').forEach(b => b.classList.remove('selected'));
      document.querySelector(`[data-preset="${name}"]`)?.classList.add('selected');
      document.getElementById('wardrobePreview').classList.add('hidden');
    }
    
    function handleWardrobe(input) {
      const file = input.files[0];
      if (!file) return;
      selectedPreset = null;
      document.querySelectorAll('.preset-item').forEach(b => b.classList.remove('selected'));
      const reader = new FileReader();
      reader.onload = e => {
        wardrobeData = e.target.result;
        document.getElementById('wardrobePreviewImg').src = wardrobeData;
        document.getElementById('wardrobePreview').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
    
    async function saveWardrobe() {
      if (!wardrobeData) return;
      const btn = document.getElementById('saveWardrobeBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';
      try {
        const formData = new FormData();
        const blob = await fetch(wardrobeData).then(r => r.blob());
        formData.append('wardrobeImage', blob, 'wardrobe.png');
        const res = await fetch('/api/wardrobe/save', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        await loadPresets();
        selectPreset(data.filename.replace('.png', ''));
        document.getElementById('wardrobePreview').classList.add('hidden');
        wardrobeData = null;
      } catch (e) {
        alert(e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save to Presets';
      }
    }
    
    async function clearPrompt() {
      document.getElementById('prompt').value = '';
      await fetch('/api/prompt/clear', { method: 'POST' });
    }
    
    async function generate() {
      if (!personData) return alert('Add your photo first');
      const providers = Array.from(document.querySelectorAll('input[name="provider"]:checked')).map(c => c.value);
      if (!providers.length) return alert('Select a model');
      
      const btn = document.getElementById('generateBtn');
      const btnText = document.getElementById('btnText');
      const btnLoading = document.getElementById('btnLoading');
      const results = document.getElementById('results');
      
      btn.disabled = true;
      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');
      results.innerHTML = '<div class="card" style="padding: 40px; text-align: center;"><div class="spinner" style="margin: 0 auto;"></div></div>';
      
      try {
        const formData = new FormData();
        formData.append('providers', JSON.stringify(providers));
        formData.append('prompt', document.getElementById('prompt').value);
        const personBlob = await fetch(personData).then(r => r.blob());
        formData.append('personImage', personBlob, 'person.png');
        if (wardrobeData) {
          const blob = await fetch(wardrobeData).then(r => r.blob());
          formData.append('wardrobeImage', blob, 'wardrobe.png');
        } else if (selectedPreset) {
          formData.append('wardrobePreset', selectedPreset);
        }
        
        const res = await fetch('/api/generate', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        
        results.innerHTML = data.results.map(r => `
          <div class="result-card">
            <div class="result-header flex items-center justify-between">
              <span>${r.provider}</span>
              <span class="text-muted">${r.error ? 'Error' : 'Done'}</span>
            </div>
            ${r.image ? `<img src="${r.image}" onclick="window.open(this.src)">` : ''}
            ${r.error ? `<div class="result-error">${r.error}</div>` : ''}
          </div>
        `).join('');
      } catch (e) {
        results.innerHTML = `<div class="card result-error">${e.message}</div>`;
      } finally {
        btn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
      }
    }
    
    function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); }
    function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }
    
    async function changePassword() {
      const pw = document.getElementById('newPassword').value;
      if (!pw) return;
      const res = await fetch('/settings/password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newPassword: pw })
      });
      if ((await res.json()).success) {
        alert('Password updated');
        document.getElementById('newPassword').value = '';
      } else {
        alert('Failed');
      }
    }
    
    async function saveKeys() {
      const geminiKey = document.getElementById('geminiKey')?.value || '';
      const xaiKey = document.getElementById('xaiKey')?.value || '';
      const res = await fetch('/settings/keys', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ geminiKey, xaiKey })
      });
      alert((await res.json()).success ? 'Keys saved' : 'Failed');
    }
    
    document.getElementById('prompt')?.addEventListener('change', async e => {
      await fetch('/api/prompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: e.target.value })
      });
    });
